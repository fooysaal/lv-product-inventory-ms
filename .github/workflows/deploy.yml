name: CD - Deploy to Server

on:
  push:
    branches:
      - main # Deploy to production
      - staging # Deploy to staging
  workflow_dispatch: # Allow manual deployment
    inputs:
      environment:
        description: "Environment to deploy to"
        required: true
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "production" ]] || [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "DEPLOY_HOST=${{ secrets.PROD_HOST }}" >> $GITHUB_ENV
            echo "DEPLOY_USER=${{ secrets.PROD_USER }}" >> $GITHUB_ENV
            echo "DEPLOY_PATH=${{ secrets.PROD_PATH }}" >> $GITHUB_ENV
            echo "APP_URL=${{ secrets.PROD_URL }}" >> $GITHUB_ENV
            echo "ENV_NAME=production" >> $GITHUB_ENV
          else
            echo "DEPLOY_HOST=${{ secrets.STAGING_HOST }}" >> $GITHUB_ENV
            echo "DEPLOY_USER=${{ secrets.STAGING_USER }}" >> $GITHUB_ENV
            echo "DEPLOY_PATH=${{ secrets.STAGING_PATH }}" >> $GITHUB_ENV
            echo "APP_URL=${{ secrets.STAGING_URL }}" >> $GITHUB_ENV
            echo "ENV_NAME=staging" >> $GITHUB_ENV
          fi

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        id: deploy
        run: |
          ssh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} "bash -s" << 'ENDSSH'
            set -e

            # Navigate to deployment directory
            cd ${{ env.DEPLOY_PATH }}

            # Pull latest changes
            git fetch origin
            git checkout ${{ github.ref_name }}
            git pull origin ${{ github.ref_name }}

            # Install/update Composer dependencies
            composer install --no-dev --optimize-autoloader --no-interaction

            # Install/update NPM dependencies and build assets
            npm ci
            npm run build

            # Run database migrations
            php artisan migrate --force

            # Clear and cache config
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            # Clear application cache
            php artisan cache:clear

            # Restart queue workers
            php artisan queue:restart

            # Set permissions
            chmod -R 775 storage bootstrap/cache

            echo "Deployment completed successfully"
          ENDSSH

          echo "url=${{ env.APP_URL }}" >> $GITHUB_OUTPUT

      - name: Deployment notification
        if: success()
        run: |
          echo "‚úÖ Successfully deployed to ${{ env.ENV_NAME }}"
          echo "üåê URL: ${{ env.APP_URL }}"

      - name: Rollback on failure
        if: failure()
        run: |
          ssh ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} "bash -s" << 'ENDSSH'
            cd ${{ env.DEPLOY_PATH }}
            git reset --hard HEAD~1
            composer install --no-dev --optimize-autoloader --no-interaction
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
          ENDSSH
          echo "‚ö†Ô∏è Deployment failed - rolled back to previous version"
